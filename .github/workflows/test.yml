  name: Test             
                                               
  on:
    push:
      branches: [main, 'feature/**', 'agent/**']
    pull_request:
      branches: [main]

  jobs:
    unit-tests:
      name: Unit Tests
      runs-on: ubuntu-latest
      strategy:
        matrix:
          python-version: ['3.11', '3.12', '3.13']

      steps:
        - uses: actions/checkout@v4

        - name: Set up Python ${{ matrix.python-version }}
          uses: actions/setup-python@v5
          with:
            python-version: ${{ matrix.python-version }}

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -e ./python pytest

        - name: Run unit tests
          run: pytest tests/ -v --ignore=tests/test_integration.py

    integration-tests:
      name: Integration Tests (Docker)
      runs-on: ubuntu-latest
      needs: unit-tests

      steps:
        - uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -e ./python pytest

        - name: Run integration tests
          run: pytest tests/ -v -m integration

        - name: Verify Docker auto-start
          run: |
            docker rm -f keep-server-9009 2>/dev/null || true
            python -c "
            from keep import ensure_server
            result = ensure_server()
            assert result, 'ensure_server() should return True'
            print('✅ ensure_server() auto-started container')
            "
            docker ps | grep keep-server-9009
            python -c "
            from keep import KeepClient
            client = KeepClient()
            client.send(b'test-packet')
            print('✅ Successfully sent packet to auto-started server')
            "
            docker rm -f keep-server-9009

    go-build:
      name: Go Build
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: '1.21'

        - name: Build server
          run: go build -o keep-server .

        - name: Run go vet
          run: go vet ./...
  EOF

